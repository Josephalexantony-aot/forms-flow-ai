#!/bin/sh

# Function to validate yes/no input
is_valid_yes() {
	case "$1" in
		[Yy]|[Yy][Ee][Ss]) return 0 ;;
		*) return 1 ;;
	esac
}

is_valid_no() {
	case "$1" in
		[Nn]|[Nn][Oo]) return 0 ;;
		*) return 1 ;;
	esac
}

# Function to get user confirmation
get_user_confirmation() {
	dir="$1"
	while true; do
		printf "Run linting and tests for '%s'? (y/n): " "$dir"
		read -r answer
		if is_valid_yes "$answer"; then
			return 0
		elif is_valid_no "$answer"; then
			return 1
		else
			echo "Please answer with Yes or No"
		fi
	done
}

remote="$1"
url="$2"

zero=$(git hash-object --stdin </dev/null | tr '[0-9a-f]' '0')
run_web_tests=0 # Flag to check if web tests should be run

while read local_ref local_oid remote_ref remote_oid
do
	if test "$local_oid" = "$zero"
	then
		# Handle delete
		:
	else
		if test "$remote_oid" = "$zero"
		then
			# New branch, examine all commits
			range="$local_oid"
		else
			# Update to existing branch, examine new commits
			range="$remote_oid..$local_oid"
		fi

		# Check if any files were changed in the forms-flow-web directory
		if git diff --name-only "$range" -- forms-flow-web/ | grep -q '.'; then
			run_web_tests=1
		fi
	fi
done

# --- Web Linting & Testing ---
if [ "$run_web_tests" -eq 1 ]; then
	echo "ℹ️  Found changes in forms-flow-web/"

	# Ask user if they want to run checks
	if ! get_user_confirmation "forms-flow-web"; then
		echo "ℹ️  Skipping checks for forms-flow-web/ as per user request"
		exit 0
	fi

	echo "ℹ️  Running linting and tests..."

	# Check if node_modules directory exists
	if [ ! -d "forms-flow-web/node_modules" ]; then
		echo "❌ Error: forms-flow-web/node_modules directory not found. Please run 'npm install' in forms-flow-web/"
		exit 1
	fi

	# Navigate into the web directory
	cd forms-flow-web || exit 1

	# Run linting
	echo "ℹ️  Running forms-flow-web linting..."
	if npm run lint; then
		echo "✅ forms-flow-web linting passed"
	else
		echo "❌ forms-flow-web linting failed. Aborting push"
		cd .. # Go back to original directory before exiting
		exit 1
	fi

	# Run tests
	echo "ℹ️  Running forms-flow-web tests..."
	if npm run test; then
		echo "✅ forms-flow-web tests passed"
	else
		echo "❌ forms-flow-web tests failed. Aborting push"
		cd .. # Go back to original directory before exiting
		exit 1
	fi

	# Go back to the original directory
	cd ..

	echo "✅ All checks passed successfully!"

else
	echo "ℹ️  No changes detected in forms-flow-web/ directory"
fi

exit 0
